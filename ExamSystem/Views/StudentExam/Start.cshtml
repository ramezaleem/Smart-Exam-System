@model ExamSystem.Models.Exam
@{
    ViewData["Title"] = "بدء الامتحان";
}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

<style>
    #timer {
        position: fixed;
        top: 20px;
        right: 30px;
        background: #17a2b8;
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 1.2rem;
        font-weight: bold;
        box-shadow: 0 0 10px rgba(23, 162, 184, 0.5);
        z-index: 1050;
        user-select: none;
    }
</style>

<h2 class="mb-4 text-success">
    <i class="fa fa-play-circle"></i> بدء الامتحان:
    <span class="badge bg-info">@Model.Title</span>
</h2>

<div id="timer" aria-live="polite" aria-atomic="true">الوقت المتبقي: --:--:--</div>

<form id="examForm" asp-controller="StudentExam" asp-action="Submit" method="post" class="card shadow p-4 mt-5">
    <div id="warningMessage" class="alert alert-warning" style="display:none;">
        من فضلك قم بإجابة جميع الأسئلة قبل الإرسال.
    </div>

    <input type="hidden" name="examId" value="@Model.Id" />

    @for (int i = 0 ; i < Model.Questions.Count ; i++)
    {
        var q = Model.Questions.ElementAt(i);
        <div class="mb-4">
            <div class="alert alert-primary">
                <b>سؤال @(i + 1):</b> <i class="fa fa-question-circle"></i> @q.Text
            </div>
            <div class="row">
                @for (int j = 0 ; j < q.Options.Count ; j++)
                {
                    var opt = q.Options.ElementAt(j);
                    <div class="col-md-6 mb-2">
                        <div class="form-check bg-light rounded shadow-sm p-2">
                            <input class="form-check-input" type="radio"
                                   name="selectedOptionIds[@q.Id]"
                                   value="@opt.Id"
                                   id="q@q.Id-opt@opt.Id"
                                   required />
                            <label class="form-check-label" for="q@q.Id-opt@opt.Id">
                                <i class="fa fa-circle text-info"></i> @opt.Text
                            </label>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <button type="submit" class="btn btn-success btn-lg w-100">
        <i class="fa fa-paper-plane"></i> إرسال الإجابات
    </button>
</form>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // حساب الوقت الكلي بناءً على الفارق بين EndTime و StartTime من الخادم
    var startTime = new Date('@Model.StartTime?.ToString("o")');
    var endTime = new Date('@Model.EndTime?.ToString("o")');

    function updateTimer() {
        var now = new Date();
        var remaining = endTime - now;

        if (remaining <= 0) {
            document.getElementById('timer').textContent = 'انتهى وقت الامتحان';
            // يمكن قفل النموذج أو إعادة التوجيه بعد انتهاء الوقت
            document.getElementById('examForm').querySelector('button[type="submit"]').disabled = true;
            clearInterval(timerInterval);
            return;
        }

        var hours = Math.floor(remaining / (1000 * 60 * 60));
        var minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((remaining % (1000 * 60)) / 1000);

        document.getElementById('timer').textContent = `الوقت المتبقي: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    updateTimer();
    var timerInterval = setInterval(updateTimer, 1000);

    document.getElementById("examForm").addEventListener("submit", function (e) {
        var warningDiv = document.getElementById("warningMessage");
        var radios = document.querySelectorAll("[name^='selectedOptionIds']");
        var questionNames = {};
        radios.forEach(function (el) { questionNames[el.name] = true; });

        var allAnswered = true;
        for (var name in questionNames) {
            var group = document.getElementsByName(name);
            var checked = false;
            for (var i = 0; i < group.length; i++) {
                if (group[i].checked) { checked = true; break; }
            }
            if (!checked) { allAnswered = false; break; }
        }
        if (!allAnswered) {
            e.preventDefault();
            warningDiv.style.display = 'block';
            return;
        } else {
            warningDiv.style.display = 'none';
        }

        e.preventDefault();
        Swal.fire({
            title: 'تأكيد الإرسال',
            text: "هل أنت متأكد من إرسال الإجابات؟ لن تستطيع تعديلها بعد الإرسال.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'نعم، إرسال',
            cancelButtonText: 'لا، العودة'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById("examForm").submit();
            }
        });
    });
</script>
